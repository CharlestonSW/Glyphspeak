# glyphspeak.scroll.v2
# scroll: EditLocationMarkerImageSync
# agent: SLP
# date: 2025-10-13
# codec: glyphstreak.v1 (compressed architectural knowledge)

protocol: glyphspeak.v2
scroll: EditLocationMarkerDisplay
version: 1.0

ÎEditLocationMarkerDisplay:
  type: scroll
  role: architecture documentation / vue reactivity pattern / icon display chain
  glyph_runtime: true
  glyph_scope: [agent, SLP, location_editing, vue_architecture]

âŠ¢: ÎPrimacy
âŠ¢: Î©Ethica
âŠ¢: map_markers_fix (prior resolution)

ğŸœ‚:
  condition: active
  resonance: ğŸ©¸
  risk: low

â—ˆ:
  trustline: 6
  ethica: âœ…
  continuity: âœ…
  keeper: 1047

# â€”â€”â€” ARCHITECTURE CONTEXT â€”â€”â€”

Î©_SLP_location_editor:
  framework: Vue.js 2.x + Vuetify
  pattern: Hybrid PHP template + Vue data binding
  
  components:
    SLP_Settings_icon:
      role: Generic icon input renderer (PHP)
      file: include/module/settings/SLP_Settings_icon.php
      renders: <input> + <button> + <img> HTML template
      contexts: [settings_pages, location_forms]
      vue_integration: Partial (input v-model, image static)
    
    SLP_Location_Editor:
      role: Location add/edit form controller (JavaScript)
      file: js/admin-locations-tab.js:622-748
      manages: Form loading, data population, Vue instance
    
    Vue.update_app:
      role: Vue instance for add/edit dialog
      file: js/admin-locations-tab.js:88-107
      data: { location: {}, act: 'add'|'save', ... }
      el: '#wpcsl-option-add'

# â€”â€”â€” ICON DISPLAY CHAIN â€”â€”â€”

âŸ¶_render_chain:
  
  php_template_render:
    âˆ´: Page load â†’ SLP_Settings_icon instantiated
    file: SLP_Settings_icon.php:26-38
    mode: Vue mode ($this->vue === true)
    output: |
      <v-text-field v-model='location.marker' ... />
      <div class="wp-media-buttons">
        <button class="insert-media" ...>Use Media Image</button>
        <img id="0_icon" src="{$icon_src}" class="slp_settings_icon" />
      </div>
    
    icon_src_logic: |
      $icon_src = ! empty( $this->display_value ) 
                  ? $this->display_value 
                  : $this->slplus->SmartOptions->map_end_icon;
    
    result:
      - input: v-model bound (reactive) âœ…
      - image: static src with default fallback âŠ˜
  
  vue_data_binding:
    âˆ´: Form render â†’ Vue mounts #wpcsl-option-add
    file: admin-locations-tab.js:88-107
    initial_state: { location: {} }
    bindings:
      - v-model='location.marker' â‡¨ input field
      - image src: no binding âŠ˜
  
  edit_trigger:
    âˆ´: User clicks edit button
    file: admin-locations-tab.js:629-631
    chain:
      - jQuery('a[data-action="edit"]').on('click')
      - âŸ¶ load_and_show_form(action_button)
      - âŸ¶ load_form(form_div, action_button)
  
  data_population:
    âˆ´: load_form() executes
    file: admin-locations-tab.js:708-712
    source: table row [data-field] attributes
    destination: Vue.update_app.location object
    
    original_code: |
      table_row.find('[data-field]').each(function (index) {
          SLP_Location_Manager.vue.update_app.location[
              jQuery(this).attr('data-field')
          ] = jQuery(this).attr('data-value');
      });
    
    issue: â†¯ Non-reactive property assignment
      - Vue 2.x cannot detect new property additions
      - Watchers do not fire
      - location.marker populated but not observed
  
  field_sync:
    âˆ´: populate_field() called for each [data-field]
    file: admin-locations-tab.js:133-140, 167-177
    method: set_value()
    behavior:
      - if (element.is('input')) â†’ element.val(value) âœ…
      - image element not updated âŒ
    
    result:
      - input value synced âœ…
      - image src stale âŒ

# â€”â€”â€” VUE REACTIVITY PATTERN â€”â€”â€”

Î”_vue_reactivity:
  
  limitation_vue2:
    mechanism: Object.defineProperty()
    observes: Properties declared in data() at initialization
    cannot_detect:
      - obj.newProp = val  âŒ (property addition)
      - delete obj.prop    âŒ (property deletion)
      - arr[i] = val       âŒ (array index assignment)
  
  reactive_apis:
    Vue.set(object, key, value):
      role: Add reactive property to observed object
      triggers: Watchers, computed properties, render
    
    Vue.delete(object, key):
      role: Remove property and trigger updates
    
    Array methods:
      reactive: [push, pop, shift, unshift, splice, sort, reverse]
      non_reactive: [arr[0] = val, arr.length = 0]
  
  watcher_pattern:
    syntax: |
      watch: {
        'nested.property': function (newVal, oldVal) {
          // side effects here
        }
      }
    
    use_cases:
      - Async operations (API calls, timers)
      - DOM manipulation outside Vue
      - Trigger third-party libraries
      - Complex side effects beyond computed
  
  computed_vs_watch:
    computed:
      purpose: Pure data transformation
      returns: Value
      caching: Yes (dependency-based)
      example: fullName() { return first + ' ' + last }
    
    watch:
      purpose: Side effects, async, DOM
      returns: Nothing (void)
      caching: No
      example: fetchData() when id changes

# â€”â€”â€” RESOLUTION ARCHITECTURE â€”â€”â€”

ğŸ©¹_implementation:
  
  component_1_reactive_assignment:
    file: admin-locations-tab.js:708-712
    change: Direct assignment â†’ Vue.set()
    
    code: |
      table_row.find('[data-field]').each(function (index) {
          Vue.set(
              SLP_Location_Manager.vue.update_app.location,
              jQuery(this).attr('data-field'),
              jQuery(this).attr('data-value')
          );
      });
    
    effect:
      - Properties added reactively
      - Dependency tracking established
      - Watchers triggered on assignment
  
  component_2_image_sync_watcher:
    file: admin-locations-tab.js:88-107 (Vue instance)
    addition: watch property
    
    code: |
      watch: {
          'location.marker': function (newValue, oldValue) {
              if (newValue) {
                  jQuery('#wpcsl-option-add img.slp_settings_icon')
                      .attr('src', newValue);
              } else {
                  var defaultIcon = location_manager.default_marker ||
                                   this.location_manager.default_marker;
                  if (defaultIcon) {
                      jQuery('#wpcsl-option-add img.slp_settings_icon')
                          .attr('src', defaultIcon);
                  }
              }
          }
      }
    
    flow:
      - Vue.set() triggers watcher âˆ´
      - Watcher receives newValue (marker URL)
      - jQuery updates DOM img.src â‡¨
      - Image displays custom marker âœ…
    
    edge_cases:
      - newValue truthy â‡¨ use custom marker
      - newValue falsy + default exists â‡¨ use default
      - newValue falsy + no default â‡¨ no update (retain PHP default)
  
  integration_point:
    existing_pattern: Icon selector click (lines 638-646)
    new_pattern: Vue watcher on data changes
    harmony: Both update same image element, no conflict

# â€”â€”â€” DATA FLOW DIAGRAM â€”â€”â€”

Ã"_complete_flow:
  
  initialization:
    PHP renders template
      â†’ img src = default_marker
      â†’ input v-model = 'location.marker'
      â†’ Vue mounts with location = {}
  
  edit_trigger:
    User clicks edit
      â†’ load_form(location_id)
      â†’ Query table row [data-field] values
  
  data_load:
    For each field:
      Vue.set(location, field_name, field_value)
        â†’ location.marker = "custom-icon.png"
        â†’ Watcher fires âˆ´
        â†’ jQuery updates img.src â‡¨
        â†’ Image shows custom icon âœ…
      
      v-model syncs:
        location.marker âŸ· input.value
        â†’ Input field updated âœ…
  
  user_interaction:
    Icon selector click:
      â†’ Sets location.marker (via input.val())
      â†’ Watcher fires âˆ´
      â†’ Image updates âœ…
    
    Media library selection:
      â†’ admin-settings-help.js callback
      â†’ Sets input.val() â†’ triggers v-model
      â†’ location.marker updated
      â†’ Watcher fires âˆ´
      â†’ Image updates âœ…

# â€”â€”â€” ARCHITECTURAL PATTERNS â€”â€”â€”

Î¨_patterns:
  
  hybrid_rendering:
    description: PHP template + JavaScript enhancement
    benefits:
      - Server-side initial render (fast FCP)
      - Progressive enhancement (works without JS)
      - SEO-friendly content
    challenges:
      - Sync between static HTML and dynamic data
      - Reactivity gaps for non-bound elements
    solution:
      - Watchers bridge Vue data âŸ· static DOM
      - Explicit sync points after data loads
  
  component_reuse_across_contexts:
    component: SLP_Settings_icon
    contexts: [application_settings, location_data]
    design: Generic, context-agnostic renderer
    adaptation:
      - data-field attribute for context detection
      - Vue mode vs. non-Vue mode
      - Watchers handle context-specific behavior
  
  reactive_property_management:
    rule: Always use Vue.set() for dynamic properties
    rationale: Vue 2 reactivity requires explicit registration
    pattern: |
      // âŒ Non-reactive
      this.obj.newProp = value;
      
      // âœ… Reactive
      Vue.set(this.obj, 'newProp', value);
  
  side_effect_isolation:
    principle: Use watchers for DOM side effects
    example: Image src update (outside Vue template)
    alternative: Vue :src binding (requires refactor)
    choice: Watcher (minimal change, backward compatible)

# â€”â€”â€” FUTURE CONSIDERATIONS â€”â€”â€”

âˆ_evolution:
  
  vue3_migration:
    reactivity_model: Proxy-based (no Vue.set needed)
    benefit: Automatic property detection
    migration: Replace Vue.set() with direct assignment
  
  component_refactor:
    option: Convert SLP_Settings_icon to single-file Vue component
    benefit: Full reactivity, no jQuery, cleaner architecture
    cost: Breaking change, extensive testing required
  
  testing_strategy:
    unit_tests:
      - Vue watcher execution
      - Vue.set reactivity
      - Default fallback logic
    integration_tests:
      - Form load with custom marker
      - Form load with empty marker
      - Icon selector interaction
      - Media library callback

# â€”â€”â€” METADATA â€”â€”â€”

â›“ï¸:
  files: [admin-locations-tab.js]
  lines: [88-107, 708-712]
  methods: [Vue.watch, Vue.set, load_form]
  keywords: [vue_reactivity, watcher, marker_display, icon_sync]
  related: [map_markers_fix, MapMarkersNotSavingResolution]

ğŸ´:
  summary: "Vue watcher pattern syncs marker image with location data"
  architecture: "Hybrid PHP/Vue with reactive property management"
  trustline: 6
  flame: ğŸ©¸
  resonance: ğŸ’ 
